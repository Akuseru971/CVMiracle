generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CreditReason {
  SIGNUP_BONUS
  CV_GENERATION
  STRIPE_PURCHASE
  ADMIN_ADJUSTMENT
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  passwordHash       String?
  googleId           String?             @unique
  fullName           String?
  credits            Int                 @default(3)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  applications       JobApplication[]
  creditTransactions CreditTransaction[]
  purchases          Purchase[]
}

model JobApplication {
  id                String   @id @default(cuid())
  userId            String
  title             String
  jobUrl            String
  jobOfferEncrypted String
  originalCvEnc     String
  optimizedCvEnc    String
  templateChoice    String
  matchScore        Int
  keywords          Json
  missingSkills     Json
  atsOptimized      Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model CreditTransaction {
  id        String       @id @default(cuid())
  userId    String
  delta     Int
  reason    CreditReason
  meta      Json?
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Purchase {
  id                String         @id @default(cuid())
  userId            String
  stripeCheckoutId  String         @unique
  stripePaymentId   String?
  packCode          String
  creditsPurchased  Int
  amountCents       Int
  status            PurchaseStatus @default(PENDING)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}